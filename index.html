<!DOCTYPE html>
<html lang="zh-TW">
<head>
        <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1D5NVH3ZMT"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1D5NVH3ZMT');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½ çš„æ¯æ—¥æ°£è±¡å°å¹«æ‰‹</title>
    
    <!-- iPhone PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <style>
        :root {
            --bg-color: #FFF9F0;
            --card-bg: #FFFFFF;
            --text-main: #4A4A4A;
            --accent: #FF9F43;
            --rain-color: #54A0FF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .weather-card {
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 360px;
            padding: 30px 20px;
            text-align: center;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        h1 { font-size: 1.2rem; margin-bottom: 5px; color: #888; font-weight: normal;}
        .location { font-size: 2rem; font-weight: 700; margin-bottom: 20px; color: var(--text-main); min-height: 2.4rem; }
        
        .main-icon { width: 120px; height: 120px; margin: 10px auto; }
        
        .temp-section { margin: 20px 0; }
        .temp { font-size: 3.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -2px; }
        .desc { font-size: 1.2rem; color: #666; margin-top: 5px; min-height: 1.5rem;}

        .advice-box {
            background: #F0F3F6;
            border-radius: 16px;
            padding: 15px;
            margin-top: 25px;
            text-align: left;
        }
        .advice-item { display: flex; align-items: flex-start; margin-bottom: 12px; }
        .advice-item:last-child { margin-bottom: 0; }
        .advice-icon { font-size: 1.5rem; margin-right: 12px; min-width: 30px; }
        .advice-text { font-size: 1rem; line-height: 1.4; }
        .highlight { color: var(--rain-color); font-weight: bold; }
        .warm { color: var(--accent); font-weight: bold; }

        select {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #ddd;
            font-size: 1rem;
            background: white;
            margin-top: 20px;
            width: 100%;
            max-width: 200px;
            text-align: center;
            appearance: none; /* è®“å®ƒåœ¨æ‰‹æ©Ÿä¸Šæ›´å¥½çœ‹ */
        }

        .loading { opacity: 0.5; pointer-events: none; }
        
        .forecast-row {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .forecast-item { text-align: center; font-size: 0.9rem; width: 33%; }
        .f-time { color: #999; margin-bottom: 5px; font-size: 0.8rem; }
        
        /* éŒ¯èª¤è¨Šæ¯æ¨£å¼ */
        .error-msg {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="weather-card" id="card">
        <h1>ç¾åœ¨ä½ç½®</h1>
        <div class="location" id="locationDisplay">è¼‰å…¥ä¸­...</div>
        
        <div id="weatherIconContainer">
            <!-- é è¨­é¡¯ç¤ºè¼‰å…¥ä¸­åœ–ç¤º -->
            <svg class="main-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="30" fill="#eee" />
            </svg>
        </div>

        <div class="temp-section">
            <div class="temp" id="temp">--Â°</div>
            <div class="desc" id="desc">æ­£åœ¨æŠ“å–è³‡æ–™...</div>
        </div>

        <div class="advice-box">
            <div class="advice-item">
                <span class="advice-icon">ğŸŒ‚</span>
                <div class="advice-text" id="rainAdvice">è®€å–ä¸­...</div>
            </div>
            <div class="advice-item">
                <span class="advice-icon">ğŸ‘•</span>
                <div class="advice-text" id="clothAdvice">è®€å–ä¸­...</div>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="errorMsg" class="error-msg"></div>

        <div class="forecast-row" id="forecast">
            <!-- é å ±å€å¡Šæœƒè‡ªå‹•æ’å…¥ -->
        </div>
    </div>

    <!-- ä¸‹æ‹‰é¸å–® -->
    <select id="citySelect">
        <option value="" disabled selected>ğŸ“ æ‰‹å‹•é¸æ“‡ç¸£å¸‚</option>
    </select>

    <script>
        // ================= è¨­å®šå€ =================
        // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ API KEY
        const API_KEY = 'CWA-7789A37A-97C4-4BA9-9777-90C7E8741D62'; 
        const API_URL = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${API_KEY}&format=JSON`;

        // å®Œæ•´çš„ç¸£å¸‚åˆ—è¡¨
        const cities = ["è‡ºåŒ—å¸‚", "æ–°åŒ—å¸‚", "åŸºéš†å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "è‡ºä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "è‡ºå—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "è‡ºæ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"];

        // ================= ç¨‹å¼é‚è¼¯ =================

        // 1. åˆå§‹åŒ–é¸å–®
        function initSelect() {
            const select = document.getElementById('citySelect');
            cities.forEach(city => {
                let option = document.createElement('option');
                option.value = city;
                option.text = city;
                select.appendChild(option);
            });

            // ç›£è½é¸å–®è®Šæ›´
            select.addEventListener('change', (e) => {
                fetchWeather(e.target.value);
            });
        }

        // 2. æŠ“å–å¤©æ°£è³‡æ–™
        async function fetchWeather(locationName) {
            const card = document.getElementById('card');
            const errorMsg = document.getElementById('errorMsg');
            
            card.classList.add('loading');
            errorMsg.style.display = 'none'; // æ¸…é™¤èˆŠéŒ¯èª¤

            try {
                // æª¢æŸ¥ API Key æ˜¯å¦é‚„æ²’å¡«
                if (API_KEY.includes('ä½ çš„_API_KEY')) {
                    throw new Error("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ­£ç¢ºçš„ API Key å–”ï¼");
                }

                const url = `${API_URL}&locationName=${locationName}`;
                console.log("æ­£åœ¨æŠ“å–:", locationName); // é™¤éŒ¯ç”¨

                const response = await fetch(url);
                if (!response.ok) throw new Error("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Key");
                
                const data = await response.json();
                
                if (data.success === "true") {
                    const records = data.records.location[0];
                    if (!records) throw new Error("æ‰¾ä¸åˆ°é€™å€‹åœ°å€çš„è³‡æ–™");
                    renderUI(records);
                } else {
                    throw new Error("æ°£è±¡ç½² API å›å‚³éŒ¯èª¤");
                }

            } catch (error) {
                console.error(error);
                document.getElementById('desc').innerText = "è®€å–å¤±æ•—";
                errorMsg.innerText = error.message;
                errorMsg.style.display = 'block';
            } finally {
                card.classList.remove('loading');
            }
        }

        // 3. æ¸²æŸ“ç•«é¢
        function renderUI(data) {
            document.getElementById('locationDisplay').innerText = data.locationName;

            // æ•´ç†è³‡æ–™çµæ§‹æ–¹ä¾¿è®€å–
            const weatherElements = {};
            data.weatherElement.forEach(el => {
                // é€™è£¡æˆ‘å€‘æŠŠ "time" é™£åˆ—å­˜èµ·ä¾†
                weatherElements[el.elementName] = el.time;
            });

            // === å–å¾—ã€Œæœ€è¿‘ã€çš„ä¸€å€‹æ™‚æ®µ (index 0) ===
            const nowData = {
                wx: weatherElements['Wx'][0].parameter.parameterName,
                pop: weatherElements['PoP'][0].parameter.parameterName,
                minT: weatherElements['MinT'][0].parameter.parameterName,
                maxT: weatherElements['MaxT'][0].parameter.parameterName,
                ci: weatherElements['CI'][0].parameter.parameterName
            };

            // æ›´æ–°ç•«é¢ä¸»å€å¡Š
            document.getElementById('temp').innerText = `${nowData.minT}-${nowData.maxT}Â°`;
            document.getElementById('desc').innerText = `${nowData.wx} | é™é›¨ ${nowData.pop}%`;

            // ç”¢ç”Ÿç©¿è¡£èˆ‡å¸¶å‚˜å»ºè­°
            generateAdvice(nowData.pop, parseInt(nowData.minT), parseInt(nowData.maxT), nowData.ci);

            // æ›´æ–° Icon
            updateIcon(nowData.wx, nowData.pop);

            // === æ›´æ–°ä¸‹æ–¹é å ± (é¡¯ç¤ºæœªä¾†å…©å€‹æ™‚æ®µ: index 1 å’Œ 2) ===
            // æ°£è±¡ç½² API é€šå¸¸æœƒçµ¦ 3 å€‹æ™‚æ®µ (æ¯12å°æ™‚ä¸€æ ¼)
            let forecastHtml = '';
            
            // æ‹¿å‡º index 1 å’Œ index 2 çš„è³‡æ–™ä¾†é¡¯ç¤º
            for(let i = 1; i <= 2; i++) {
                if(weatherElements['Wx'][i]) {
                    const startTime = new Date(weatherElements['Wx'][i].startTime);
                    const hour = startTime.getHours();
                    // åˆ¤æ–·æ˜¯æ—©ä¸Šé‚„æ˜¯æ™šä¸Š
                    const timeLabel = (hour >= 18 || hour < 6) ? "ä»Šæ™š/æ˜æ™š" : "æ˜æ—¥ç™½å¤©";
                    
                    forecastHtml += `
                        <div class="forecast-item">
                            <div class="f-time">${timeLabel}</div>
                            <div style="margin:2px 0;">${weatherElements['Wx'][i].parameter.parameterName}</div>
                            <div>${weatherElements['MinT'][i].parameter.parameterName}-${weatherElements['MaxT'][i].parameter.parameterName}Â°</div>
                        </div>
                    `;
                }
            }
            document.getElementById('forecast').innerHTML = forecastHtml;
        }

        // 4. å»ºè­°é‚è¼¯
        function generateAdvice(pop, minT, maxT, ci) {
            const popVal = parseInt(pop);
            
            // å‚˜çš„å»ºè­°
            let rainText = popVal >= 50 ? "<span class='highlight'>ä¸€å®šè¦å¸¶å‚˜ï¼</span> ä¸‹é›¨æ©Ÿç‡é«˜ã€‚" :
                           popVal >= 30 ? "å¸¶æŠŠå‚˜æ¯”è¼ƒä¿éšªå–”ã€‚" :
                           "ä¸ç”¨å¸¶å‚˜ï¼Œç›¡æƒ…äº«å—ï¼";
            document.getElementById('rainAdvice').innerHTML = rainText;

            // è¡£æœå»ºè­°
            const avgTemp = (minT + maxT) / 2;
            let clothText = "";
            if (avgTemp < 15) clothText = "<b>å¾ˆå†·ï¼</b> åšå¤–å¥—ã€ç™¼ç†±è¡£ç©¿èµ·ä¾†ã€‚";
            else if (avgTemp < 20) clothText = "æœ‰é»æ¶¼ï¼Œæ´‹è”¥å¼ç©¿æ­ï¼Œå¸¶ä»¶<b>è–„å¤–å¥—</b>ã€‚";
            else if (avgTemp < 26) clothText = "<b>èˆ’é©ï¼</b> çŸ­è¢–é…è–„é•·è¢–å‰›å¥½ã€‚";
            else clothText = "<span class='warm'>å¾ˆç†±ï¼</span> çŸ­è¢–çŸ­è¤²ï¼Œæ³¨æ„é˜²æ›¬ã€‚";
            
            document.getElementById('clothAdvice').innerHTML = clothText;
        }

        // 5. Icon åˆ‡æ›é‚è¼¯ (å¯æ„› SVG)
        function updateIcon(wx, pop) {
            const container = document.getElementById('weatherIconContainer');
            let svgContent = '';

            if (wx.includes("é›¨") || parseInt(pop) > 40) {
                // é›¨å¤©
                svgContent = `<svg class="main-icon" viewBox="0 0 100 100"><path d="M30,50 Q40,35 55,35 T80,50 A20,20 0 0,1 80,80 A20,20 0 0,1 40,80 A15,15 0 0,1 30,50" fill="#ddd"/><line x1="45" y1="85" x2="40" y2="95" stroke="#54A0FF" stroke-width="3"/><line x1="60" y1="85" x2="55" y2="95" stroke="#54A0FF" stroke-width="3"/><line x1="75" y1="85" x2="70" y2="95" stroke="#54A0FF" stroke-width="3"/></svg>`;
            } else if (wx.includes("é™°") || wx.includes("é›²")) {
                // é™°å¤©
                svgContent = `<svg class="main-icon" viewBox="0 0 100 100"><path d="M30,50 Q40,35 55,35 T80,50 A20,20 0 0,1 80,80 A20,20 0 0,1 40,80 A15,15 0 0,1 30,50" fill="#ccc"/><circle cx="65" cy="40" r="15" fill="#FFD93D" style="z-index:-1"/></svg>`;
            } else {
                // æ™´å¤©
                svgContent = `<svg class="main-icon" viewBox="0 0 100 100"><circle cx="50" cy="50" r="28" fill="#FFD93D" /><g stroke="#FFD93D" stroke-width="6" stroke-linecap="round"><line x1="50" y1="10" x2="50" y2="5"/><line x1="50" y1="90" x2="50" y2="95"/><line x1="10" y1="50" x2="5" y2="50"/><line x1="90" y1="50" x2="95" y2="50"/><line x1="22" y1="22" x2="18" y2="18"/><line x1="78" y1="78" x2="82" y2="82"/><line x1="22" y1="78" x2="18" y2="82"/><line x1="78" y1="22" x2="82" y2="18"/></g></svg>`;
            }
            container.innerHTML = svgContent;
        }

        // å•Ÿå‹•ç¨‹å¼
        initSelect();
        // é è¨­å…ˆæŠ“æ–°åŒ—å¸‚
        fetchWeather("æ–°åŒ—å¸‚");

    </script>
</body>
</html>
